# Cardano Charts

## Documentation

The README documentation is generated by [helm-docs](https://github.com/norwoodj/helm-docs)

Install the Azure Key Vault provider:

```
helm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts
helm install csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --generate-name --set secrets-store-csi-driver.syncSecret.enabled=true --namespace kube-system
```

Customize the options as needed, and install this Chart:

```
helm repo add cardano https://regel.github.io/cardano-charts
helm upgrade --install pool \
  --values cardano/values.yaml \
  --set vault.csi.enabled=false \
  --set producer.enabled=false \
  --set environment.name=testnet \
  --set persistence.sourceFile.enabled=true \
  --set persistence.sourceFile.url=$(curl -s https://downloads.csnapshots.io/snapshots/testnet/testnet-db-snapshot.json| jq -r .[].file_name) \
    cardano/cardano
```

```
helm upgrade --install testnet ./cardano \
   -f ./cardano/values-testnet.yaml \
   -n testnet \
   --set redis.auth.existingSecret=redis-secret \
   --set vault.csi.enabled=false \
   --set producer.enable=false
```
```
helm upgrade --install testnet ./cardano \
   --values ./cardano/values-testnet.yaml \
   --set vault.csi.enabled=false \
   --set producer.enable=false \
   --set environment.name=testnet \
   -n testnet
```

```
helm upgrade testnet ./cardano \
   --values ./cardano/values-testnet.yaml \
   --set vault.csi.enabled=false \
   --set producer.enable=false \
   --set environment.name=testnet \
   -n testnet
```

#### Query the Blockchain

Change the pod namespace and `cardano-cli` options according to the chain id, chart namespace and release name, and run:

```
kubectl exec -ti -n mainnet mainnet-cardano-relay-0 -c node -- cardano-cli query tip --mainnet
```

## FAQ

### Solving Init:Error when producer starts for the first time

Synchronizing the Cardano blockchain from scratch takes a long time. To prevent long waiting times, the Init container
attempts to download a snapshot of the blockchain during their first installation. However, egress traffic
is blocked for producer nodes and the 'restore' init container cannot download the snapshot:

```
$ kubectl get po -w
NAME                     READY   STATUS     RESTARTS   AGE
pool-cardano-producer-0  0/1     Init:3/4   0          46s
pool-cardano-relay-0     2/2     Running    0          52m
pool-cardano-producer-0  0/1     Init:Error   0          2m35s
```

The workaround is to disable network policies manually during Init:

```
$ kubectl delete networkpolicy -l app.kubernetes.io/name=cardano,app.kubernetes.io/component=producer
```
Enable policies again with `helm upgrade` when the producer node is running.

